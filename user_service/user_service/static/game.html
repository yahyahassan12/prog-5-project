<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tic Tac Toe — Game</title>
<style>
  :root{
    --bg: linear-gradient(180deg,#071021 0%, #0b1220 60%);
    --card: rgba(255,255,255,0.03);
    --muted: #98a0b3;
    --accent: #6ee7b7;
    --accent-2: #60a5fa;
    --glass: rgba(255,255,255,0.04);
    --shadow: 0 12px 30px rgba(2,6,23,0.6);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#e6eef8;-webkit-font-smoothing:antialiased;}
  .wrap{max-width:900px;margin:36px auto;padding:20px;}
  .card{background:var(--card);border-radius:14px;padding:22px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.02)}
  .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
  .meta{color:var(--muted);font-size:14px}
  .board{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;width:360px;margin:0 auto}
  .cell{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); aspect-ratio:1;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:48px;font-weight:700;color:#e6eef8;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
  .cell.disabled{opacity:0.45;cursor:not-allowed}
  .status{margin-top:12px;text-align:center;color:var(--muted)}
  .btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;background:transparent;color:var(--muted);backdrop-filter: blur(4px); border:1px solid rgba(255,255,255,0.03)}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#04202b;border:0}
  .players{font-size:14px;color:var(--muted);margin-bottom:6px}
  @media (max-width:600px){ .board{width:260px;gap:8px} .cell{font-size:36px} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main">
      <div class="top">
        <div>
          <div style="font-weight:700;font-size:18px">Tic Tac Toe</div>
          <div class="meta">Room <span id="roomId">-</span></div>
        </div>
        <div>
          <div class="meta" id="playerName">Player: -</div>
          <button id="back" class="btn">Back to Lobby</button>
        </div>
      </div>

      <div class="players" id="players">Players: —</div>
      <div id="board" class="board" role="grid" aria-label="Tic Tac Toe board"></div>

      <div class="status" id="status">Connecting…</div>
      <div style="margin-top:14px;text-align:center">
        <button id="leaveBtn" class="btn">Leave Room</button>
        <button id="newBtn" class="btn primary" style="margin-left:8px; display:none">New Game</button>
      </div>
    </div>
  </div>

<script>
  // Config
  const params = new URLSearchParams(location.search);
  const room = params.get("room") || "";
  const token = localStorage.getItem("auth_token");
  const username = localStorage.getItem("last_username") || "player";
  document.getElementById("roomId").textContent = room || "-";
  document.getElementById("playerName").textContent = "Player: " + username;

  const WS_HOST = "127.0.0.1:8003"; // adjust if needed
  const WS_PATH = "/ws";          // server ws path (query: ?room=...)
  const BOARD_EL = document.getElementById("board");
  const STATUS_EL = document.getElementById("status");
  const PLAYERS_EL = document.getElementById("players");
  const BACK_BTN = document.getElementById("back");
  const LEAVE_BTN = document.getElementById("leaveBtn");
  const NEW_BTN = document.getElementById("newBtn");

  let ws = null;
  let state = null;

  function setStatus(t){ STATUS_EL.textContent = t || ""; }
  function renderBoard(board){
    BOARD_EL.innerHTML = "";
    for (let i=0;i<9;i++){
      const d = document.createElement("div");
      d.className = "cell";
      d.dataset.pos = i;
      d.textContent = board[i] || "";
      if (board[i]) d.classList.add("disabled");
      d.onclick = ()=> onCellClick(i);
      BOARD_EL.appendChild(d);
    }
  }

  function updateUI(g){
    state = g;
    renderBoard(g.board);
    PLAYERS_EL.textContent = "Players: " + (g.players ? g.players.join(", ") : "—");
    if (g.state === "finished"){
      if (g.winner === "draw") setStatus("Game finished — Draw");
      else setStatus("Game finished — Winner: " + g.winner);
      NEW_BTN.style.display = "inline-block";
    } else {
      setStatus((g.turn ? "Turn: " + g.turn : "") + (g.turn === username ? " (your turn)" : ""));
      NEW_BTN.style.display = "none";
    }
  }

  function connect(){
    setStatus("Connecting to game server...");
    const proto = location.protocol === "https:" ? "wss" : "ws";
    const qtoken = token ? `&token=${encodeURIComponent(token)}` : "";
    const url = `${proto}://${WS_HOST}${WS_PATH}?room=${encodeURIComponent(room)}${qtoken}`;
    ws = new WebSocket(url);

    ws.onopen = ()=> setStatus("Connected — waiting for state...");
    ws.onmessage = (ev)=> {
      try {
        const msg = JSON.parse(ev.data);
        // Accept both message schemas: {board, turn, players, state, winner} or wrapped {type, game}
        if (msg.game) updateUI(msg.game);
        else if (msg.board) updateUI(msg);
        else if (msg.type === "info") setStatus(msg.detail || "Info");
        else console.log("WS:", msg);
      } catch(e){ console.error("ws parse", e, ev.data); }
    };
    ws.onclose = ()=> { setStatus("Disconnected — attempting reconnect..."); setTimeout(connect, 1200); };
    ws.onerror = (e)=> console.error("ws err", e);
  }

  function onCellClick(pos){
    if (!state) return;
    if (state.state === "finished") return;
    if (state.board[pos]) return setStatus("Cell occupied");
    if (state.turn !== username) return setStatus("Not your turn");
    if (!ws || ws.readyState !== WebSocket.OPEN) return setStatus("Not connected");
    const msg = {type:"move", pos, player: username};
    // some servers expect {cmd:"move", position:pos} — both are common; your server earlier accepted {type:"move",pos,player}
    ws.send(JSON.stringify(msg));
  }

  BACK_BTN.onclick = ()=> { location.href = "/static/lobby.html"; };
  LEAVE_BTN.onclick = async ()=> {
    try {
      await fetch(`http://127.0.0.1:8002/leave-room/${encodeURIComponent(room)}`, {method:"POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({username})});
    } catch(e){}
    localStorage.removeItem("auth_token");
    location.href = "/static/lobby.html";
  };
  NEW_BTN.onclick = ()=> {
    // simple local re-create: call room service create -> wait redirect
    alert("Request server to create new match (server implementation required).");
  };

  if (!room) { setStatus("No room provided in URL"); } else { connect(); }
</script>
</body>
</html>
